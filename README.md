# [Micro-expression recognition using dual-branch 3DCNN network with novel attention mechanism]

## Chun-Ting Fang, Tsung-Jung Liu, Kuan-Hsien Liu  

***
> Abstract : Abstract—Micro-expressions refer to small and imperceptible changes in facial expressions displayed by humans in a very
short period of time, but these changes contain rich emotional information. In this paper, we propose a shallow dual-branch
3D-CNN backbone network architecture in the first stage as preliminary temporal and spatial feature learning. At the same
time, we have also enhanced and optimized the CAM (Channel Attention Module) within CBAM (Convolutional Block Attention
Module) so that it can be better applied to the extraction of subtle changes in micro-expression faces. Then we use GRU (gated
recurrent unit) and MSMH (multi-scale multi-head attention mechanism) as the second stage feature self-attention extraction.
The facial action unit (AU) is used to cut out key areas where micro-expressions occur to enhance the learning effect
of local features. In addition to testing on commonly used microexpression datasets, we also tested on lie detection datasets.
A large number of experimental results show that this method can achieve very good results with relatively simple input and
attention mechanisms.


## Network Architecture  

<table>
  <tr>
    <td colspan="2"><img src = "https://github.com/dannyFan-0201/Micro-Expression-Recognition-Using-A-Dual-Branch-3DCNN-Network/blob/main/img/model%20architecture.PNG" alt="CMFNet" width="1000"> </td>  
    
  </tr>
  
</table>

# Environment
- Python 3.9.0
- Tensorflow 2.10.1
- keras	2.10.0
- opencv-python	
- tensorboard	
- colorama
- 
or see the requirements.txt

# How to try

## Download dataset (places2、CelebA、ImageNet)
[SMIC] [SAMM] [CASME II] [CAS(ME)3] [Real-life deception detection Database]

## Set dataset path

Edit txt/xxx.txt (set path in config)
```python

data_path = './txt/train_path.txt'
mask_path = './txt/train_mask_path.txt'
val_path = './txt/val_path.txt'
val_mask_path = './val_mask_file/' # path
test_path: './txt/test_path.txt'
test_mask_1_60_path: './test_mask_1+10_file/' # path

```

txt example
```python

E:/Places2/data_256/00000001.jpg
E:/Places2/data_256/00000002.jpg
E:/Places2/data_256/00000003.jpg
E:/Places2/data_256/00000004.jpg
E:/Places2/data_256/00000005.jpg
 ⋮

```

## Preprocessing  
In this implementation, masks are automatically generated by ourself. stroke masks mixed randomly to generate proportion from 1% to 60%.

strokes (from left to right 20%-30% 30%-40% 40%-50% 50%-60%)
<img src="https://imgur.com/m3CStkN.png" alt="https://imgur.com/m3CStkN.png" title="https://imgur.com/m3CStkN.png" width="1000" height="200">

## Pretrained model
["Here"](https://drive.google.com/drive/u/4/folders/1QeLZc7_4TZVZ7awRQXNmgvGtPl6OGUAR) (Updated to open download permission)

## Run training
```python

python train.py (main setting data_path/mask_path/val_path/val_mask_path/batch_size/train_epoch)

```
1. set the config path ('./config/model_config.yml')
2. Set path and parameter details in model_config.yml

Note: If the training is interrupted and you need to resume training, you can set resume_ckpt and resume_D_ckpt.

## Run testing
```python

python test.py (main setting test_ckpt/test_path/test_mask_1_60_path/save_img_path)

```
1. set the config path ('./config/model_config.yml')
2. Set path and parameter details in model_config.yml

## Quantitative comparison

- Places2 & CelebA

<img src="https://i.imgur.com/WelO9t7.png" width="1312" height="250">

Quantitative evaluation of inpainting on Places2 and CelebA datasets. We report Peak signal-to-noise ratio (PSNR), structural similarity (SSIM) and Learned Perceptual Image Patch Similarity (LPIPS) metrics. The ▲ denotes larger, and ▼ denotes lesser of the parameters compared to our proposed model. (Bold means the 1st best; Underline means the 2nd best)

All training and testing base on same 3060.

## Qualitative comparisons

- Places2

<img src="https://i.imgur.com/FMGm4mB.jpg" width="1000" style="zoom:100%;">

Qualitative results of Places2 dataset among all compared models. From left to right: Masked image, DeepFill_v2, HiFill, Iconv, AOT-GAN, HiFill, CRFill, TFill, and Ours. Zoom-in for details.

- CelebA

<img src="https://i.imgur.com/hPPQQ3W.jpg" width="1000" style="zoom:100%;">

Qualitative results of CelebA dataset among all compared models. From left to right: Masked image, RW, DeepFill_v2, Iconv, AOT-GAN, CRFill, TFill, and Ours. Zoom-in for details.

## Ablation study

- Transformer and HSV loss

<div align=center>
<img src="https://i.imgur.com/DoYLVKD.png" width="410" height="150"><img src="https://imgur.com/Utxgfzs.jpg" width="410" height="150">
</div>

(left) : Ablation study label of transformer and HSV experiment.

(right) : Ablation study of color deviation on inpainted images. From left to right: Masked images, w/o TotalHSV loss, and TotalHSV loss (w/o V).

## Object removal

<div align=center>
<img src="https://i.imgur.com/IYIMow7.jpg" width="1300" height="350">
</div>

Object removal (size 256×256) results. From left to right: Original image, mask, object removal result.


## Acknowledgement
This repository utilizes the codes of following impressive repositories   
- [ZITS](https://github.com/DQiaole/ZITS_inpainting)
- [LaMa](https://github.com/saic-mdal/lama)
- [CSWin Transformer](https://github.com/microsoft/CSWin-Transformer)
- [Vision Transformer](https://github.com/google-research/vision_transformer)

---
## Contact
If you have any question, feel free to contact wiwi61666166@gmail.com

## Citation
```

@inproceedings{chen2023lightweight,
 title={Lightweight Image Inpainting By Stripe Window Transformer With Joint Attention To CNN},
 author={Chen, Bo-Wei and Liu, Tsung-Jung and Liu, Kuan-Hsien},
 booktitle={2023 IEEE 33rd International Workshop on Machine Learning for Signal Processing (MLSP)},
 pages={1--6},
 year={2023},
 organization={IEEE}
 }
